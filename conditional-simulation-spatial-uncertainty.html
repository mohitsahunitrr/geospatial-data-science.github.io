<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Conditional Simulation for Spatial Uncertainty</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Geospatial Data Science</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Spatial Data Processing with R
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about.html">Content</a>
    </li>
    <li>
      <a href="getting-started-with-r.html">Getting Started with R</a>
    </li>
    <li>
      <a href="read-write-spatial-data.html">Read and Write Spatial Data in R</a>
    </li>
    <li>
      <a href="map-projection-coordinate-reference-systems.html">Map Projection and Coordinate Reference Systems</a>
    </li>
    <li>
      <a href="geoprocessing-vector-data.html">Geoprocessing of Vector data</a>
    </li>
    <li>
      <a href="working-with-spatial-point-data.html">Working with Spatial Point Data</a>
    </li>
    <li>
      <a href="working-with-spatial-polygon.html">Working with Spatial Polygon Data</a>
    </li>
    <li>
      <a href="working-with-raster-data.html">Working with Raster Data</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Spatial Statistics with R
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about-b.html">Content</a>
    </li>
    <li>
      <a href="spatial-statistics.html">Spatial Statistics</a>
    </li>
    <li>
      <a href="spatial-autocorrelation.html">Spatial Autocorrelation</a>
    </li>
    <li>
      <a href="geographically-weighted-models.html">Geographically Weighted Model</a>
    </li>
    <li>
      <a href="geographically-weighted-summary-statistics.html">Geographically Weighted Summary Statistics</a>
    </li>
    <li>
      <a href="geographically-weighted-principal-components-analysis.html">Geographically Weighted Principal Components Analysis</a>
    </li>
    <li>
      <a href="geographically-weighted-regression.html">Geographically Weighted Regression</a>
    </li>
    <li>
      <a href="spatial-interpolation.html">Spatial Interpolation</a>
    </li>
    <li>
      <a href="deterministic-methods-for-spatial-interpolation.html">Deterministic Methods for Spatial Interpolation</a>
    </li>
    <li>
      <a href="geostatistical-methods-for-spatial-interpolation.html">Geostatistical Methods for Spatial Interpolation</a>
    </li>
    <li>
      <a href="semivariogram-modeling.html">Semivariogram Modeling</a>
    </li>
    <li>
      <a href="kriging.html">Kriging</a>
    </li>
    <li>
      <a href="ordinary-kriging.html">Ordinary Kriging</a>
    </li>
    <li>
      <a href="universal-kriging.html">Universal Kriging</a>
    </li>
    <li>
      <a href="cokriging.html">Co-Kriging</a>
    </li>
    <li>
      <a href="regression-kriging.html">Regression kriging</a>
    </li>
    <li>
      <a href="indicator-kriging.html">Indicator kriging</a>
    </li>
    <li>
      <a href="assessing-quality-spatial-predictions.html">Assessing the Quality of Spatial Predictions</a>
    </li>
    <li>
      <a href="cross-validation.html">Cross-validation</a>
    </li>
    <li>
      <a href="validation-independent-dataset.html.">Validation with an Independent Dataset</a>
    </li>
    <li>
      <a href="conditional-simulation-spatial-uncertainty.html">Conditional Simulation for Spatial Uncertainty</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Remote Sensing Data with R
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about-c.html">Content</a>
    </li>
    <li>
      <a href="reomte-sensing-basic.html">Remote Sensing Basic</a>
    </li>
    <li>
      <a href="landsat-8-image-processing.html">Landsat 8 Image Processing &amp; Visualization</a>
    </li>
    <li>
      <a href="spectral-indices.html">Spectral Indices</a>
    </li>
    <li>
      <a href="uav-ground-cover.html">Green Ground Cover from UAV Images</a>
    </li>
    <li>
      <a href="texture-analysis.html">Texture Analysis</a>
    </li>
    <li>
      <a href="image-classification.html">Image Classification</a>
    </li>
    <li>
      <a href="ground-truth-data-processing.html">Ground Truth Data Processing</a>
    </li>
    <li>
      <a href="unsupervised-classification.html">Unsupervised Classification</a>
    </li>
    <li>
      <a href="supervised-classification.html">Supervised Classification</a>
    </li>
    <li>
      <a href="random-forest.html">Random Forest</a>
    </li>
    <li>
      <a href="support-vector-machine.html">Support Vector Machine</a>
    </li>
    <li>
      <a href="naive-bayes.html">Na√Øve Bayes</a>
    </li>
    <li>
      <a href="exboost.html">eXtreme Gradient Boosting</a>
    </li>
    <li>
      <a href="deep-learning-h2o.html">Deep Learning with H20</a>
    </li>
    <li>
      <a href="dnn-keras-tensorflow.html">Deep Learning with Keras-TensorFlow</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="mailto:zia207@gmail.com">
    <span class="fa fa-envelope fa-lg"></span>
     
    Email
  </a>
</li>
<li>
  <a href="http://github.com/zia207">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://www.linkedin.com/in/zia-ahmed-a7653578">
    <span class="fa fa-linkedin fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Conditional Simulation for Spatial Uncertainty</h1>

</div>


<div style="margin-bottom:40px;">

</div>
<p>This kriging prediction map smooth out local details of spatial distribution of the attribute under study, with small values being overestimated while large values are underestimated especially in area with low sampling density (Isaaks and Srivastava 1989). Conditional sequential Gaussian simulation (CSGS) techniques, unlike kriging, produce a better picture of reality and eliminate the unrealistic smoothing with focusing on the reproduction of global statistics or the semivariogram model in addition to honoring of original data values (Goovaerts 1997). The set of alternative realizations generated with CSGS provides a degree of uncertainty about the spatial prediction, which usually uses to draw reliable probability map of the variables under study (Goovaerts 1997). The CSGS is thus increasingly preferred to kriging for characterization of uncertainty for decision and risk analysis rather producing the best unbiased prediction of un-sampled location as is done with kriging (Deutsch and Journel 1998).</p>
<div id="load-package" class="section level4">
<h4>Load package:</h4>
<pre class="r"><code>library(plyr)
library(dplyr)
library(gstat)
library(raster)
library(rasterVis)
library(ggplot2)
library(car)
library(sp)
library(classInt)
library(RStoolbox)
library(gridExtra)</code></pre>
</div>
<div id="load-data" class="section level4">
<h4>Load Data</h4>
<p>The soil organic carbon data (train and test data set) that we have created before is available for download from <a href="https://www.dropbox.com/s/d6nnlu2da93mp48/DATA_08.7z?dl=0">here</a>.</p>
<pre class="r"><code># Define data folder
dataFolder&lt;-&quot;F:\\Spatial_Data_Processing_and_Analysis_R\\Data\\DATA_08\\&quot;</code></pre>
<pre class="r"><code>state&lt;-shapefile(paste0(dataFolder,&quot;GP_STATE.shp&quot;))
train&lt;-read.csv(paste0(dataFolder,&quot;train_data.csv&quot;), header= TRUE) 
grid&lt;-read.csv(paste0(dataFolder, &quot;GP_prediction_grid_data.csv&quot;), header= TRUE)
grid.xy&lt;-grid[,1:3]</code></pre>
</div>
<div id="data-transformation" class="section level3">
<h3>Data Transformation</h3>
<p>Power Transform uses the maximum likelihood-like approach of Box and Cox (1964) to select a transformation of a univariate or multivariate response for normality. First we have to calculate appropriate <strong>transformation parameters</strong> using <strong>powerTransform()</strong> function of <strong>car</strong> package and then use this parameter to transform the data using <strong>bcPower()</strong> function.</p>
<pre class="r"><code>powerTransform(train$SOC)</code></pre>
<pre><code>## Estimated transformation parameter 
## train$SOC 
## 0.2523339</code></pre>
<pre class="r"><code>train$SOC.bc&lt;-bcPower(train$SOC, 0.2523339)</code></pre>
<p>First. we have to define x &amp; y variables as coordinates</p>
<pre class="r"><code>coordinates(train) = ~x+y
coordinates(grid) = ~x+y</code></pre>
</div>
<div id="variogram-modeling" class="section level3">
<h3>Variogram Modeling</h3>
<pre class="r"><code># Variogram
v&lt;-variogram(SOC.bc~ 1, data = train, cloud=F)
# Intial parameter set by eye esitmation
m&lt;-vgm(1.5,&quot;Exp&quot;,40000,0.5)
# least square fit
m.f&lt;-fit.variogram(v, m)
m.f</code></pre>
<pre><code>##   model     psill    range
## 1   Nug 0.5165678     0.00
## 2   Exp 1.0816886 82374.23</code></pre>
<div id="plot-varigram-and-fitted-model" class="section level4">
<h4>Plot varigram and fitted model</h4>
<pre class="r"><code>#### Plot varigram and fitted model:
plot(v, pl=F, 
     model=m.f,
     col=&quot;black&quot;, 
     cex=0.9, 
     lwd=0.5,
     lty=1,
     pch=19,
     main=&quot;Variogram and Fitted Model\n Box-Cox Transformed SOC&quot;,
     xlab=&quot;Distance (m)&quot;,
     ylab=&quot;Semivariance&quot;)</code></pre>
<p><img src="conditional-simulation-spatial-uncertainty_files/figure-html/unnamed-chunk-8-1.png" width="432" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="ordinary-kriging" class="section level3">
<h3>Ordinary kriging</h3>
<pre class="r"><code>ok.soc&lt;-krige(SOC.bc~1, 
              train, 
              grid,
              model=m.f, 
              nmax=50
              )</code></pre>
<pre><code>## [using ordinary kriging]</code></pre>
<pre class="r"><code># back transformation
k1&lt;-1/0.2523339                                   
grid.xy$OK &lt;-((ok.soc$var1.pred *0.2523339+1)^k1)</code></pre>
<div style="margin-bottom:20px;">

</div>
</div>
<div id="conditional-gaussian-simulation" class="section level3">
<h3>Conditional Gaussian Simulation</h3>
<p>The <strong>krige()</strong> method can also do conditional simulations. It requires one optional argument: <strong>nsim</strong>, the number of conditional simulations</p>
<pre class="r"><code>set.seed(130)
nsim=100
sim.soc&lt;-krige(SOC.bc~1, 
              train, 
              grid,
              model=m.f, 
              nmax=50, 
              nsim = nsim)</code></pre>
<pre><code>## drawing 100 GLS realisations of beta...
## [using conditional Gaussian simulation]</code></pre>
</div>
<div id="semiveriograms-of-all-realizations" class="section level3">
<h3>Semiveriograms of All Realizations</h3>
<p>Simulation is supposed to respect the spatial structure- same structure as the variogram model. Now will produce varigrams of 100 realization and plot them varigram of box-cox transform SOC.</p>
<pre class="r"><code>plot(v$gamma ~ v$dist, xlim = c(0, max(v$dist) * 1.05),
ylim=c(0,2),
pch = 19, col = &quot;black&quot;,cex=.5,
cex.axis = 0.8, cex.lab=1, xlab = list(&quot;Distance (m)&quot;,cex=1), ylab =list(&quot;Semivariance&quot;,cex=1),
main=list(&quot;Semi-variogram of 100 Realizations&quot;,cex=1))
for(i in 1:100) {
   sg.v=paste(&quot;sim&quot;,i,sep=&quot;&quot;)
   fg.v = as.formula(paste(sg.v, &quot;~1&quot;))
   vg.v = variogram(fg.v, sim.soc)
   lines(variogramLine(fit.variogram(vg.v, m.f),
   maxdist = max(v$dist)),lty=3, col = &quot;grey&quot;)
}
points(v$gamma ~ v$dist,pch = 19, col = &quot;red&quot;,cex=.3)
lines(variogramLine(fit.variogram(v,  m.f), 
maxdist = max(v$dist)), col = &quot;red&quot;,  lwd=1.0)</code></pre>
<p><img src="conditional-simulation-spatial-uncertainty_files/figure-html/unnamed-chunk-11-1.png" width="576" style="display: block; margin: auto;" /></p>
<div id="back-transformation" class="section level4">
<h4>Back transformation</h4>
<pre class="r"><code>for(i in 1:length(sim.soc@data)){sim.soc@data[[i]] &lt;- (((sim.soc[[i]]*0.2523339+1)^k1))}
sim.data&lt;-as.data.frame(sim.soc)</code></pre>
</div>
</div>
<div id="visualization-of-spatial-uncetinity" class="section level3">
<h3>Visualization of Spatial Uncetinity</h3>
<p>The set of realizations provides a measure of uncertainty about the spatial distribution of arsenic concentration. Differences among the realizations describe the uncertainty. Such uncertainty can be visualized through an animated display of all realizations Which allows to distinguish areas that remain stable over all realizations (low uncertainty) from those where large fluctuations occur between realizations (high uncertainty).</p>
<div id="data-preparation" class="section level4">
<h4>Data preparation</h4>
<pre class="r"><code>soc=sim.data[,3:102]
soc.stack=stack(soc)
round(quantile(soc.stack$values, probs=seq(0,1, by=.1)),1)</code></pre>
<pre><code>##   0%  10%  20%  30%  40%  50%  60%  70%  80%  90% 100% 
##  0.0  1.3  2.1  2.9  3.7  4.7  5.8  7.2  9.2 12.5 68.1</code></pre>
<pre class="r"><code>at.soc=classIntervals(soc.stack$values, n = 10, style = &quot;quantile&quot;)$brks
rgb.palette &lt;- colorRampPalette(c(&quot;red&quot; ,&quot;yellow&quot;,&quot;green&quot;,&quot;blue&quot;),space = &quot;rgb&quot;)
bound &lt;- list(&quot;sp.lines&quot;, as(state, &quot;SpatialLines&quot;), col=&quot;grey40&quot;, lwd=.8,lty=1)
coordinates(sim.data) &lt;- ~x+y
gridded(sim.data) &lt;- TRUE</code></pre>
<p>To create an animation map in R, you have to install <em>animation</em> packages in R. This package depends on <a href="https://www.imagemagick.org/"><em>ImageMagick</em></a> software.</p>
<pre class="r"><code>library(animation)</code></pre>
<p>After installation, you have define PATH of this software.</p>
<pre class="r"><code>Sys.setenv(PATH = paste(&quot;C:\\Program Files\\ImageMagick-7.0.6-0-Q16&quot;, Sys.getenv(&quot;PATH&quot;), sep = &quot;;&quot;))
ani.options(convert=&quot;C:\\Program Files\\ImageMagick-7.0.6-0-Q16\\covert.exe&quot;)
magickPath&lt;-shortPathName(&quot;C:\\Program Files\\ImageMagick-7.0.6-0-Q16-x64\\magick.exe&quot;)
ani.options(convert=magickPath)</code></pre>
</div>
<div id="animation-map" class="section level4">
<h4>Animation Map</h4>
<pre class="r"><code>saveGIF(
for (i in 1:100){
print(spplot(sim.data[,i], main = list(label=paste(&quot;Realization&quot;,i),cex=1.5),
sp.layout=list(bound),
   par.settings=list(axis.line=list(col=&quot;grey25&quot;,lwd=0.5)),at=at.soc,
   colorkey=list(space=&quot;right&quot;,width=1.4,at=1:11,labels=list(cex=1.2,at=1:11,
   labels=c(&quot;&quot;,   &quot;&lt; 1.2&quot;,   &quot;&quot;,   &quot; 2.9&quot;, &quot;&quot;,  &quot; 4.7&quot;,  &quot;&quot;,  &quot; 7.2&quot;, &quot;&quot;,  &quot;&gt; 12.5&quot;,  &quot;&quot;))),
   col.regions=rgb.palette(20)))}, 
height = 600, width = 600, interval = .5, outdir = getwd())</code></pre>
<div class="figure">
<img src="FIGURE_SOC_SIM_ANIMATION.gif" />

</div>
</div>
</div>
<div id="measures-of-local-uncertinity" class="section level3">
<h3>Measures of Local Uncertinity</h3>
<p>Now, we will measure local uncertainty by comparing, E-tpye (mean), conditional qauntiles maps of expected probability of 10%, 50% (median) and 90%.</p>
<pre class="r"><code># E-type estimate
df&lt;-as.data.frame(sim.data)
df&lt;-df[,1:100]
grid.xy$mean&lt;-as.data.frame(rowMeans(df[sapply(df, is.numeric)]))
names(grid.xy)[5]&lt;-&quot;Etype&quot;
## Conditional Quantiles
grid.xy$q10&lt;-apply(as.data.frame(sim.data)[3:102],1,stats::quantile,probs = 0.1,na.rm=TRUE) 
grid.xy$Median&lt;-apply(as.data.frame(sim.data)[3:102],1,stats::quantile,probs = 0.5,na.rm=TRUE)
grid.xy$q90&lt;-apply(as.data.frame(sim.data)[3:102],1,stats::quantile,probs = 0.9,na.rm=TRUE)</code></pre>
<pre class="r"><code>coordinates(grid.xy) &lt;- ~x+y
gridded(grid.xy) &lt;- TRUE</code></pre>
<pre class="r"><code>col &lt;- colorRampPalette(c(&quot;red&quot; ,&quot;yellow&quot;,&quot;green&quot;,&quot;blue&quot;,&quot;sky blue&quot;),space = &quot;rgb&quot;)
spplot(grid.xy, c(4:5), sp.layout=list(bound), col.regions=col(20),
       names.attr = c(&quot;Ordinary Kriging&quot;, &quot;E-type Estimates&quot;))</code></pre>
<p><img src="conditional-simulation-spatial-uncertainty_files/figure-html/unnamed-chunk-19-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>Ordinary predicted and E-type estimates of 100 realizations are not identical, although both are optimal of least-squares criterion.</p>
<div id="conditional-quantile-maps" class="section level4">
<h4>Conditional Quantile Maps</h4>
<pre class="r"><code>spplot(grid.xy, c(&quot;q10&quot;,&quot;Median&quot;,&quot;q90&quot;), sp.layout=list(bound), col.regions=col(20),
       names.attr = c(&quot;0.1-quantile&quot;, &quot;Median&quot;,&quot;0.9 Quantile&quot;))</code></pre>
<p><img src="conditional-simulation-spatial-uncertainty_files/figure-html/unnamed-chunk-20-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>High Soil carbon (yellow part) of 0.1-quantile map indicate areas where unknown SOC concentration certainly large, whereas low value parts of (dark yellow) of the 0.9-qauntile map where concentration of SOC certainly small.</p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
